<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AV ç®¡ç†å™¨ - ç´”è‡ªå‹•åŒ–æ¼”å“¡ç‰ˆ</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --border: #30363d; --success: #238636; }
        * { box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 320px; background: #010409; padding: 25px; border-right: 1px solid var(--border); overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; }
        h2 { font-size: 0.9rem; color: var(--accent); margin: 20px 0 10px; text-transform: uppercase; letter-spacing: 1px; }
        .display-pool { background: #0d1117; border: 1px solid var(--border); border-radius: 6px; margin: 10px 0; max-height: 250px; overflow-y: auto; }
        .pool-item { display: flex; justify-content: space-between; padding: 8px 12px; font-size: 13px; border-bottom: 1px solid #21262d; color: #8b949e; }

        /* ä¸»å€åŸŸ */
        .main { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .toolbar { background: var(--card); padding: 15px 30px; border-bottom: 1px solid var(--border); }
        .scroll-container { flex-grow: 1; padding: 30px; overflow-y: auto; }

        /* å¡ç‰‡è¨­è¨ˆ - 16:9 æ¯”ä¾‹ */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; }
        .video-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: 0.2s; }
        .video-card:hover { border-color: var(--accent); }
        
        .cover-box { width: 100%; aspect-ratio: 16 / 9; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .cover-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .info-box { padding: 15px; }
        .video-code { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 8px; display: block; }
        
        /* æ¼”å“¡é¡¯ç¤ºå€ (ä¸å¯ç·¨è¼¯) */
        .actor-label { font-size: 13px; color: #3fb950; font-weight: bold; margin-bottom: 10px; display: block; }
        
        /* æ¨™ç±¤ç®¡ç†å€ */
        .tag-section { margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px; }
        .pill-box { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .pill { font-size: 11px; padding: 3px 12px; border-radius: 20px; background: rgba(255, 123, 114, 0.1); border: 1px solid #ff7b72; color: #ff7b72; cursor: pointer; }
        
        .btn-main { background: var(--success); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; }
        input[type="text"], select { background: #0d1117; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; width: 100%; }
        input[type="file"] { display: none; }

        .status-msg { font-size: 12px; color: var(--accent); margin: 5px 0; font-family: monospace; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ“ 1. è‡ªå‹•æƒæå¼•æ“</h2>
    <p style="font-size:11px; color:#8b949e; line-height:1.4;">è®€å–æ ¼å¼: <br><code style="color:#e6edf3;">!ç•ªè™Ÿ_æ¼”å“¡_å°é¢.jpg</code></p>
    <button class="btn-main" onclick="document.getElementById('dirIn').click()">é¸å–æƒæè³‡æ–™å¤¾</button>
    <input type="file" id="dirIn" webkitdirectory directory multiple onchange="handleFolderScan(this)">
    
    <div id="status" class="status-msg"></div>

    <h2>ğŸ­ å·²åµæ¸¬æ¼”å“¡æ¸…å–®</h2>
    <div class="display-pool" id="actorPoolDisplay"></div>

    <h2>ğŸ·ï¸ æ¨™ç±¤åº«ç®¡ç†</h2>
    <input type="text" id="tagIn" placeholder="æ–°å¢è‡ªå®šç¾©æ¨™ç±¤..." onkeypress="if(event.key==='Enter') addToPool('tagPool')">
    <div class="display-pool" id="tagPoolDisplay"></div>

    <button class="btn-main" style="margin-top:auto; background:#21262d; border:1px solid var(--border)" onclick="exportData()">ğŸ“¤ åŒ¯å‡º TXT æˆæœ</button>
</div>

<div class="main">
    <div class="toolbar">
        <input type="text" id="search" placeholder="ğŸ” æœå°‹ç•ªè™Ÿã€æ¼”å“¡æˆ–æ¨™ç±¤å…§å®¹..." oninput="refreshUI()">
    </div>
    <div class="scroll-container">
        <div class="video-grid" id="grid"></div>
    </div>
</div>

<script>
    const db = new Dexie("AV_PureAuto_DB");
    db.version(1).stores({
        videos: '++id, &code, *actors, *tags',
        actorPool: '++id, &name',
        tagPool: '++id, &name'
    });

    const coverCache = {};

    async function handleFolderScan(input) {
        const files = Array.from(input.files);
        if (files.length === 0) return;

        document.getElementById('status').innerText = ">> æ­£åœ¨è§£ææª”åèˆ‡æ¼”å“¡...";
        
        const scanResults = {}; 

        for (let file of files) {
            const parts = file.webkitRelativePath.split('/');
            if (parts.length < 2) continue;
            
            const code = parts[1].toUpperCase();
            if (!scanResults[code]) scanResults[code] = { actors: new Set() };

            // åš´æ ¼è§£æ: !ç•ªè™Ÿ_æ¼”å“¡_å°é¢
            if (file.name.startsWith('!') && file.name.includes('å°é¢')) {
                const fileNameNoExt = file.name.split('.')[0];
                const segments = fileNameNoExt.split('_');
                
                if (segments.length >= 3) {
                    const actorName = segments[1].trim();
                    
                    // 1. ç¶å®šåœ–ç‰‡
                    if (!coverCache[code]) coverCache[code] = URL.createObjectURL(file);
                    
                    // 2. ç´€éŒ„è©²ç•ªè™Ÿçš„æ¼”å“¡
                    scanResults[code].actors.add(actorName);
                    
                    // 3. åŒæ­¥æ¼”å“¡åº«
                    const actorInPool = await db.actorPool.where('name').equalsIgnoreCase(actorName).first();
                    if (!actorInPool) await db.actorPool.add({ name: actorName });
                }
            }
        }

        for (let code in scanResults) {
            const video = await db.videos.where('code').equalsIgnoreCase(code).first();
            const actorsArray = Array.from(scanResults[code].actors);
            
            if (video) {
                // è‡ªå‹•æ›´æ–°æ¼”å“¡ï¼ˆä»¥æª”åç‚ºæº–ï¼‰
                await db.videos.update(video.id, { actors: actorsArray });
            } else {
                await db.videos.add({ code, actors: actorsArray, tags: [] });
            }
        }

        document.getElementById('status').innerText = ">> åŒæ­¥å®Œæˆ";
        renderPools();
    }

    // --- ç®¡ç†é‚è¼¯ ---

    async function addToPool(table) {
        const input = document.getElementById('tagIn');
        if (!input.value.trim()) return;
        try { await db[table].add({ name: input.value.trim() }); } catch(e) {}
        input.value = '';
        renderPools();
    }

    async function renderPools() {
        const actors = await db.actorPool.toArray();
        const tags = await db.tagPool.toArray();
        
        document.getElementById('actorPoolDisplay').innerHTML = actors.map(item => `
            <div class="pool-item"><span>${item.name}</span></div>
        `).join('');

        document.getElementById('tagPoolDisplay').innerHTML = tags.map(item => `
            <div class="pool-item">
                <span>${item.name}</span>
                <span style="color:#f85149; cursor:pointer;" onclick="deleteFromPool('tagPool', ${item.id})">Ã—</span>
            </div>
        `).join('');
        refreshUI();
    }

    async function deleteFromPool(table, id) {
        await db[table].delete(id);
        renderPools();
    }

    async function refreshUI() {
        const q = document.getElementById('search').value.toLowerCase();
        let videos = await db.videos.reverse().toArray();
        const tagPool = await db.tagPool.toArray();

        if (q) {
            videos = videos.filter(v => v.code.toLowerCase().includes(q) || 
                                     v.actors.some(a=>a.toLowerCase().includes(q)) || 
                                     v.tags.some(t=>t.toLowerCase().includes(q)));
        }

        document.getElementById('grid').innerHTML = videos.map(v => `
            <div class="video-card">
                <div class="cover-box">
                    ${coverCache[v.code] ? `<img src="${coverCache[v.code]}">` : `<div style="color:#484f58; font-size:11px;">éœ€åœ–æª”: !${v.code}_æ¼”å“¡_å°é¢</div>`}
                </div>
                <div class="info-box">
                    <span class="video-code">${v.code}</span>
                    <span class="actor-label">ğŸ­ ${v.actors.join(', ') || 'æœªçŸ¥æ¼”å“¡'}</span>
                    
                    <div class="tag-section">
                        <div class="pill-box">${v.tags.map(t => `<span class="pill" onclick="removeTag(${v.id}, 'tags', '${t}')">${t}</span>`).join('')}</div>
                        <select onchange="updateTag(${v.id}, 'tags', this.value); this.value=''">
                            <option value="">+ æ–°å¢æ¨™ç±¤</option>
                            ${tagPool.map(t => `<option value="${t.name}">${t.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function updateTag(id, field, val) {
        const v = await db.videos.get(id);
        const set = new Set(v[field]);
        set.add(val);
        await db.videos.update(id, { [field]: Array.from(set) });
        refreshUI();
    }

    async function removeTag(id, field, val) {
        const v = await db.videos.get(id);
        await db.videos.update(id, { [field]: v[field].filter(x => x !== val) });
        refreshUI();
    }

    async function exportData() {
        const list = await db.videos.toArray();
        let txt = "ç•ªè™Ÿ | æ¼”å“¡ | æ¨™ç±¤\n" + list.map(v => `${v.code} | ${v.actors.join(', ') || 'ç„¡æ¼”å“¡è³‡æ–™'} | ${v.tags.join(', ') || 'ç„¡æ¨™ç±¤è³‡æ–™'}`).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain'}));
        a.download = "AVåˆ†é¡æˆæœ.txt";
        a.click();
    }

    renderPools();
</script>
</body>
</html>

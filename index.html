<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AV è¦–è¦ºåŒ–ç®¡ç† - æ™ºæ…§è§£æç‰ˆ</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --border: #30363d; --success: #238636; }
        * { box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; background: #010409; padding: 20px; border-right: 1px solid var(--border); overflow-y: auto; flex-shrink: 0; }
        .main { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .toolbar { background: var(--card); padding: 15px 25px; border-bottom: 1px solid var(--border); }
        .scroll-container { flex-grow: 1; padding: 25px; overflow-y: auto; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .video-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .cover-box { width: 100%; aspect-ratio: 16 / 9; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .cover-box img { width: 100%; height: 100%; object-fit: cover; }
        .info-box { padding: 15px; }
        .video-code { font-size: 1.1rem; font-weight: bold; color: var(--accent); }
        .display-pool { background: #0d1117; border: 1px solid var(--border); border-radius: 6px; margin: 10px 0; max-height: 150px; overflow-y: auto; font-size: 13px; }
        .pool-item { display: flex; justify-content: space-between; padding: 6px 12px; border-bottom: 1px solid #21262d; }
        .btn-main { background: var(--success); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; }
        .pill { font-size: 11px; padding: 2px 10px; border-radius: 12px; background: rgba(88, 166, 255, 0.1); border: 1px solid var(--accent); cursor: pointer; margin: 2px; display: inline-block; }
        input[type="file"] { display: none; }
        input[type="text"], select { background: #0d1117; border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; width: 100%; margin-top: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ“ è‡ªå‹•æƒæ (è§£ææª”å)</h2>
    <p style="font-size:11px; color:#8b949e;">æ ¼å¼éœ€æ±‚: !ç•ªè™Ÿ_æ¼”å“¡_å°é¢.jpg</p>
    <button class="btn-main" onclick="document.getElementById('dirIn').click()">é¸å–å¤§è³‡æ–™å¤¾</button>
    <input type="file" id="dirIn" webkitdirectory directory multiple onchange="handleFolderScan(this)">
    
    <div id="status" style="font-size:12px; color:var(--accent); margin-bottom:10px;"></div>

    <h2>ğŸ­ æ¼”å“¡åº« (è‡ªå‹•æ–°å¢)</h2>
    <div class="display-pool" id="actorPoolDisplay"></div>

    <h2>ğŸ·ï¸ æ¨™ç±¤åº«</h2>
    <input type="text" id="tagIn" placeholder="è¼¸å…¥æ¨™ç±¤æŒ‰ Enter..." onkeypress="if(event.key==='Enter') addToPool('tagPool')">
    <div class="display-pool" id="tagPoolDisplay"></div>

    <button class="btn-main" style="margin-top:20px; background:#21262d; border:1px solid var(--border)" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºåˆ†é¡ TXT</button>
</div>

<div class="main">
    <div class="toolbar">
        <input type="text" id="search" placeholder="ğŸ” æœå°‹ç•ªè™Ÿã€æ¼”å“¡æˆ–æ¨™ç±¤..." oninput="refreshUI()">
    </div>
    <div class="scroll-container">
        <div class="video-grid" id="grid"></div>
    </div>
</div>

<script>
    const db = new Dexie("AV_Smart_Parsing_DB");
    db.version(1).stores({
        videos: '++id, &code, *actors, *tags',
        actorPool: '++id, &name',
        tagPool: '++id, &name'
    });

    const coverCache = {};

    async function handleFolderScan(input) {
        const files = Array.from(input.files);
        const codesFound = new Set();
        let newActorsCount = 0;

        document.getElementById('status').innerText = "æ™ºæ…§è§£æä¸­...";

        for (let file of files) {
            const pathParts = file.webkitRelativePath.split('/');
            if (pathParts.length < 2) continue;

            const folderCode = pathParts[1].toUpperCase();
            codesFound.add(folderCode);

            // æ™ºæ…§è§£æè¦å‰‡: !ç•ªè™Ÿ_æ¼”å“¡_å°é¢
            // æª”åç¯„ä¾‹: !JUFE-093_ä¸‰èˆ¹ã‹ã‚Œã‚“_å°é¢.jpg
            if (file.name.startsWith('!') && file.name.includes('å°é¢')) {
                const fileNameNoExt = file.name.split('.')[0]; // å»é™¤å‰¯æª”å
                const segments = fileNameNoExt.split('_'); // ç”¨åº•ç·šåˆ‡å‰²

                if (segments.length >= 3) {
                    const actorName = segments[1]; // å–å¾—æ¼”å“¡åç¨±
                    
                    // 1. ç·©å­˜åœ–ç‰‡
                    if (!coverCache[folderCode]) {
                        coverCache[folderCode] = URL.createObjectURL(file);
                    }

                    // 2. è‡ªå‹•å°‡æ¼”å“¡åŠ å…¥å…¨åŸŸæ¼”å“¡åº«
                    const actorExists = await db.actorPool.where('name').equalsIgnoreCase(actorName).count();
                    if (actorExists === 0) {
                        await db.actorPool.add({ name: actorName });
                        newActorsCount++;
                    }

                    // 3. è‡ªå‹•å°‡æ¼”å“¡é—œè¯åˆ°è©²éƒ¨å½±ç‰‡ (å¾ŒçºŒ refreshUI æœƒè™•ç†)
                    const video = await db.videos.where('code').equalsIgnoreCase(folderCode).first();
                    if (video) {
                        const currentActors = new Set(video.actors);
                        currentActors.add(actorName);
                        await db.videos.update(video.id, { actors: Array.from(currentActors) });
                    }
                }
            }
        }

        // å»ºç«‹ç•ªè™ŸåŸºç¤è³‡æ–™
        for (let code of codesFound) {
            try { await db.videos.add({ code, actors: [], tags: [] }); } catch (e) {}
        }

        document.getElementById('status').innerText = `æƒæå®Œæˆï¼æ–°å¢ ${newActorsCount} ä½æ¼”å“¡ã€‚`;
        renderPools();
    }

    async function addToPool(table) {
        const input = table === 'actorPool' ? document.getElementById('actIn') : document.getElementById('tagIn');
        if (!input.value.trim()) return;
        try { await db[table].add({ name: input.value.trim() }); } catch(e) {}
        input.value = '';
        renderPools();
    }

    async function renderPools() {
        const actors = await db.actorPool.toArray();
        const tags = await db.tagPool.toArray();
        const render = (data, elId, table) => {
            document.getElementById(elId).innerHTML = data.map(item => `
                <div class="pool-item"><span>${item.name}</span><span style="color:#f85149; cursor:pointer;" onclick="deleteFromPool('${table}', ${item.id})">Ã—</span></div>
            `).join('');
        };
        render(actors, 'actorPoolDisplay', 'actorPool');
        render(tags, 'tagPoolDisplay', 'tagPool');
        refreshUI();
    }

    async function deleteFromPool(table, id) {
        await db[table].delete(id);
        renderPools();
    }

    async function refreshUI() {
        const q = document.getElementById('search').value.toLowerCase();
        let videos = await db.videos.reverse().toArray();
        const actPool = await db.actorPool.toArray();
        const tagPool = await db.tagPool.toArray();

        if (q) videos = videos.filter(v => v.code.toLowerCase().includes(q) || v.actors.some(a=>a.toLowerCase().includes(q)) || v.tags.some(t=>t.toLowerCase().includes(q)));

        document.getElementById('grid').innerHTML = videos.map(v => `
            <div class="video-card">
                <div class="cover-box">
                    ${coverCache[v.code] ? `<img src="${coverCache[v.code]}">` : `<div style="color:#484f58; font-size:12px;">ç„¡ç¬¦åˆæ ¼å¼å°é¢<br>!ç•ªè™Ÿ_æ¼”å“¡_å°é¢</div>`}
                </div>
                <div class="info-box">
                    <span class="video-code">${v.code}</span>
                    <div style="margin-top:10px;">
                        <select onchange="updateTag(${v.id}, 'actors', this.value); this.value=''">
                            <option value="">+ é¸æ“‡æ¼”å“¡</option>
                            ${actPool.map(a => `<option value="${a.name}">${a.name}</option>`).join('')}
                        </select>
                        <div class="pill-box">${v.actors.map(a => `<span class="pill" onclick="removeTag(${v.id}, 'actors', '${a}')">${a}</span>`).join('')}</div>
                    </div>
                    <div style="margin-top:10px;">
                        <select onchange="updateTag(${v.id}, 'tags', this.value); this.value=''">
                            <option value="">+ é¸æ“‡æ¨™ç±¤</option>
                            ${tagPool.map(t => `<option value="${t.name}">${t.name}</option>`).join('')}
                        </select>
                        <div class="pill-box">${v.tags.map(t => `<span class="pill" style="border-color:#ff7b72; color:#ff7b72;" onclick="removeTag(${v.id}, 'tags', '${t}')">${t}</span>`).join('')}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function updateTag(id, field, val) {
        const v = await db.videos.get(id);
        const set = new Set(v[field]);
        set.add(val);
        await db.videos.update(id, { [field]: Array.from(set) });
        refreshUI();
    }

    async function removeTag(id, field, val) {
        const v = await db.videos.get(id);
        await db.videos.update(id, { [field]: v[field].filter(x => x !== val) });
        refreshUI();
    }

    async function exportData() {
        const list = await db.videos.toArray();
        let txt = "ç•ªè™Ÿ | æ¼”å“¡ | æ¨™ç±¤\n" + list.map(v => `${v.code} | ${v.actors.join(', ') || 'ç„¡æ¼”å“¡è³‡æ–™'} | ${v.tags.join(', ') || 'ç„¡æ¨™ç±¤è³‡æ–™'}`).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain'}));
        a.download = "AVåº«å­˜_æ™ºæ…§è§£æç‰ˆ.txt";
        a.click();
    }

    renderPools();
</script>
</body>
</html>

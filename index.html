<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AV ç®¡ç†å™¨ - å®Œæ•´ç¶²æ ¼ç®¡ç†ç‰ˆ</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --border: #30363d; --success: #238636; }
        * { box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 320px; background: #010409; padding: 25px; border-right: 1px solid var(--border); overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; }
        .display-pool { background: #0d1117; border: 1px solid var(--border); border-radius: 6px; margin: 10px 0; max-height: 180px; overflow-y: auto; }
        .pool-item { display: flex; justify-content: space-between; padding: 8px 12px; font-size: 13px; border-bottom: 1px solid #21262d; color: #8b949e; }

        /* ä¸»å€åŸŸ */
        .main { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .toolbar { background: var(--card); padding: 15px 30px; border-bottom: 1px solid var(--border); }
        .scroll-container { flex-grow: 1; padding: 30px; overflow-y: auto; }

        /* å¡ç‰‡è¨­è¨ˆ */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .video-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .cover-box { width: 100%; aspect-ratio: 16 / 9; background: #000; overflow: hidden; cursor: pointer; position: relative; }
        .cover-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .info-box { padding: 15px; }
        .video-code { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 5px; display: block; }
        .actor-label { font-size: 13px; color: #3fb950; font-weight: bold; display: block; margin-bottom: 10px; }
        
        .pill-box { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .pill { font-size: 11px; padding: 3px 12px; border-radius: 20px; background: rgba(255, 123, 114, 0.1); border: 1px solid #ff7b72; color: #ff7b72; cursor: pointer; }

        /* --- ç›¸ç°¿ç‰† Overlay (ç¶²æ ¼æ’é–‹) --- */
        #album-overlay { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0, 0, 0, 0.98); z-index: 9999; 
            flex-direction: column; 
        }
        .album-header { 
            padding: 15px 30px; background: #010409; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border);
        }
        .album-content { flex: 1; overflow-y: auto; padding: 25px; }
        .photo-wall { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 15px; 
        }
        .photo-wall img { width: 100%; border-radius: 4px; border: 1px solid #30363d; }

        /* å…¬ç”¨å…ƒä»¶ */
        .btn-main { background: var(--success); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; }
        input[type="text"], select { background: #0d1117; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; width: 100%; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div id="album-overlay" onclick="closeAlbum()">
    <div class="album-header" onclick="event.stopPropagation()">
        <div id="album-title" style="font-weight: bold; color: var(--accent);">ç›¸ç°¿å…§å®¹</div>
        <div style="color:white; cursor:pointer; font-size: 35px; line-height: 1;" onclick="closeAlbum()">&times;</div>
    </div>
    <div class="album-content">
        <div class="photo-wall" id="photo-wall" onclick="event.stopPropagation()"></div>
    </div>
</div>

<div class="sidebar">
    <h2>ğŸ“ è‡ªå‹•æƒæå¼•æ“</h2>
    <button class="btn-main" onclick="document.getElementById('dirIn').click()">é¸å–æˆæ¬Šè³‡æ–™å¤¾</button>
    <input type="file" id="dirIn" webkitdirectory directory multiple onchange="handleFolderScan(this)">
    <div id="status" style="font-size:12px; color:var(--accent); margin:10px 0;"></div>

    <h2>ğŸ­ å·²åµæ¸¬æ¼”å“¡</h2>
    <div class="display-pool" id="actorPoolDisplay"></div>

    <h2>ğŸ·ï¸ æ¨™ç±¤åº«ç®¡ç†</h2>
    <input type="text" id="tagIn" placeholder="æ–°å¢è‡ªå®šç¾©æ¨™ç±¤..." onkeypress="if(event.key==='Enter') addToPool('tagPool')">
    <div class="display-pool" id="tagPoolDisplay"></div>

    <button class="btn-main" style="margin-top:auto; background:#21262d; border:1px solid var(--border)" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºæˆæœ TXT</button>
</div>

<div class="main">
    <div class="toolbar">
        <input type="text" id="search" placeholder="ğŸ” æœå°‹ç•ªè™Ÿã€æ¼”å“¡æˆ–æ¨™ç±¤..." oninput="refreshUI()">
    </div>
    <div class="scroll-container">
        <div class="video-grid" id="grid"></div>
    </div>
</div>

<script>
    const db = new Dexie("AV_FullGrid_DB");
    db.version(1).stores({
        videos: '++id, &code, *actors, *tags',
        actorPool: '++id, &name',
        tagPool: '++id, &name'
    });

    let coverCache = {}; 
    let allImagesCache = {}; 

    async function handleFolderScan(input) {
        const files = Array.from(input.files);
        if (files.length === 0) return;
        document.getElementById('status').innerText = ">> è§£æç…§ç‰‡ä¸­...";
        const scanResults = {}; 

        for (let file of files) {
            const parts = file.webkitRelativePath.split('/');
            if (parts.length < 2) continue;
            const code = parts[1].toUpperCase();
            if (!scanResults[code]) scanResults[code] = { actors: new Set() };
            if (!allImagesCache[code]) allImagesCache[code] = [];

            if (file.type.startsWith("image/")) {
                const url = URL.createObjectURL(file);
                allImagesCache[code].push(url);
                if (file.name.startsWith('!') && file.name.includes('å°é¢')) {
                    const segments = file.name.split('.')[0].split('_');
                    if (segments.length >= 3) {
                        const actorName = segments[1].trim();
                        coverCache[code] = url;
                        scanResults[code].actors.add(actorName);
                        const exist = await db.actorPool.where('name').equalsIgnoreCase(actorName).first();
                        if (!exist) await db.actorPool.add({ name: actorName });
                    }
                }
            }
        }

        for (let code in scanResults) {
            const video = await db.videos.where('code').equalsIgnoreCase(code).first();
            const actorsArray = Array.from(scanResults[code].actors);
            if (video) await db.videos.update(video.id, { actors: actorsArray });
            else await db.videos.add({ code, actors: actorsArray, tags: [] });
        }
        document.getElementById('status').innerText = ">> åŒæ­¥å®Œæˆ";
        renderPools();
    }

    function openAlbum(code) {
        const photos = allImagesCache[code];
        if (!photos || photos.length === 0) return;
        const wall = document.getElementById('photo-wall');
        wall.innerHTML = photos.map(src => `<img src="${src}">`).join('');
        document.getElementById('album-title').innerText = `${code} (${photos.length} å¼µç…§ç‰‡)`;
        document.getElementById('album-overlay').style.display = 'flex';
    }

    function closeAlbum() {
        document.getElementById('album-overlay').style.display = 'none';
        document.getElementById('photo-wall').innerHTML = '';
    }

    async function addToPool(table) {
        const input = document.getElementById('tagIn');
        if (!input.value.trim()) return;
        try { await db[table].add({ name: input.value.trim() }); } catch(e) {}
        input.value = '';
        renderPools();
    }

    async function renderPools() {
        const actors = await db.actorPool.toArray();
        const tags = await db.tagPool.toArray();
        document.getElementById('actorPoolDisplay').innerHTML = actors.map(i => `<div class="pool-item">${i.name}</div>`).join('');
        document.getElementById('tagPoolDisplay').innerHTML = tags.map(i => `<div class="pool-item"><span>${i.name}</span><span style="color:#ff7b72; cursor:pointer;" onclick="deleteFromPool('tagPool', ${i.id})">Ã—</span></div>`).join('');
        refreshUI();
    }

    async function deleteFromPool(table, id) { await db[table].delete(id); renderPools(); }

    async function refreshUI() {
        const q = document.getElementById('search').value.toLowerCase();
        let videos = await db.videos.reverse().toArray();
        const tagPool = await db.tagPool.toArray();

        if (q) videos = videos.filter(v => v.code.toLowerCase().includes(q) || v.actors.some(a=>a.toLowerCase().includes(q)) || v.tags.some(t=>t.toLowerCase().includes(q)));

        document.getElementById('grid').innerHTML = videos.map(v => `
            <div class="video-card">
                <div class="cover-box" onclick="openAlbum('${v.code}')">
                    ${coverCache[v.code] ? `<img src="${coverCache[v.code]}">` : `<div style="padding:20px; color:#484f58; text-align:center;">æŸ¥çœ‹ç¶²æ ¼ç›¸ç°¿</div>`}
                </div>
                <div class="info-box">
                    <span class="video-code">${v.code}</span>
                    <span class="actor-label">ğŸ­ ${v.actors.join(', ') || 'æœªçŸ¥æ¼”å“¡'}</span>
                    <div class="pill-box">${v.tags.map(t => `<span class="pill" onclick="removeTag(${v.id}, 'tags', '${t}')">${t}</span>`).join('')}</div>
                    <select onchange="updateTag(${v.id}, 'tags', this.value); this.value=''">
                        <option value="">+ æ–°å¢æ¨™ç±¤</option>
                        ${tagPool.map(t => `<option value="${t.name}">${t.name}</option>`).join('')}
                    </select>
                </div>
            </div>
        `).join('');
    }

    async function updateTag(id, field, val) {
        if (!val) return;
        const v = await db.videos.get(id);
        const set = new Set(v[field]); set.add(val);
        await db.videos.update(id, { [field]: Array.from(set) });
        refreshUI();
    }

    async function removeTag(id, field, val) {
        const v = await db.videos.get(id);
        await db.videos.update(id, { [field]: v[field].filter(x => x !== val) });
        refreshUI();
    }

    async function exportData() {
        const list = await db.videos.toArray();
        let txt = "ç•ªè™Ÿ | æ¼”å“¡ | æ¨™ç±¤\n" + list.map(v => `${v.code} | ${v.actors.join(', ') || 'ç„¡'} | ${v.tags.join(', ') || 'ç„¡'}`).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain'}));
        a.download = "åˆ†é¡æˆæœ.txt";
        a.click();
    }

    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAlbum(); });
    renderPools();
</script>
</body>
</html>
